<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>업그레이드 주사위 게임</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body, button {
            font-family: 'Noto Sans KR', sans-serif;
            touch-action: manipulation;
        }
        .app-container {
            max-width: 420px;
            height: 100vh;
            max-height: 800px;
            box-shadow: 0 0 40px rgba(79, 70, 229, 0.5); /* Indigo glow */
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid #4f46e5;
        }
        .neon-text {
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #f0abfc, 0 0 20px #f0abfc;
        }
        .neon-button {
            background-image: linear-gradient(to right, #6366f1, #a855f7, #ec4899);
            box-shadow: 0 0 10px #a855f7, 0 0 20px #a855f7;
            transition: all 0.3s ease;
        }
        .neon-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px #a855f7, 0 0 30px #a855f7;
        }
        @keyframes roll {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(360deg) scale(1.3); }
            100% { transform: rotate(720deg) scale(1); }
        }
        .dice-rolling { animation: roll 0.7s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes popup-appear {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .popup-enter { animation: popup-appear 0.3s ease-out forwards; }
        .players-wrapper {
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .players-wrapper::-webkit-scrollbar { display: none; }
        .player-card {
            flex-shrink: 0;
            width: 120px;
            transition: all 0.3s ease;
        }
        .mission-card {
             box-shadow: 0 0 15px #ec4899;
             border: 2px solid #ec4899;
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center p-4 h-screen">

    <div class="app-container w-full h-full bg-gray-900 text-white flex flex-col relative">

        <header class="p-4 text-center z-10">
            <h1 class="text-2xl font-black neon-text">🔥 술자리 갓겜 🔥</h1>
        </header>
        
        <div id="players-container" class="players-wrapper p-3 space-x-3">
            <!-- Player cards generated by JS -->
        </div>

        <main class="flex-grow flex flex-col items-center justify-center space-y-6 px-4">
            <div class="flex space-x-6">
                <div id="dice1" class="text-8xl text-white"><i class="fas fa-dice-one"></i></div>
                <div id="dice2" class="text-8xl text-white"><i class="fas fa-dice-one"></i></div>
            </div>
            <div id="roll-result" class="text-center h-16 flex items-center justify-center">
                <p class="text-xl font-medium text-gray-300">누구 차례? 가보자고!</p>
            </div>
        </main>
        
        <footer class="p-4 space-y-3 border-t border-gray-700">
            <button id="rollBtn" class="w-full text-white font-bold py-4 px-6 rounded-xl text-xl neon-button">
                가보자고! 🎲
            </button>
             <button id="resetBtn" class="w-full bg-gray-700 text-gray-300 font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                리셋
            </button>
        </footer>

        <!-- Mission/Penalty Popup -->
        <div id="missionPopup" class="absolute inset-0 bg-black bg-opacity-80 flex items-center justify-center p-6 hidden z-50">
            <div class="bg-gray-800 rounded-2xl shadow-lg w-full max-w-sm text-center p-6 popup-enter mission-card">
                <h2 id="missionTitle" class="text-2xl font-bold text-pink-400 mb-4"></h2>
                <p id="missionMessage" class="text-gray-200 mb-6 min-h-[50px]"></p>
                <div id="missionOptions" class="space-y-2 mb-4"></div>
                <div id="missionActionButtons" class="flex space-x-2">
                    <button id="blackKnightBtn" class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-500 transition-colors">흑기사 호출 ⚔️</button>
                    <button id="closeMissionBtn" class="w-full bg-pink-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-pink-600 transition-colors">확인</button>
                </div>
            </div>
        </div>
        
        <!-- Win Popup -->
        <div id="winPopup" class="absolute inset-0 bg-black bg-opacity-80 flex items-center justify-center p-6 hidden z-50">
            <div class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-sm text-center p-8 popup-enter border-2 border-amber-400" style="box-shadow: 0 0 20px #f59e0b;">
                <div class="text-7xl mb-4">👑</div>
                <h2 class="text-3xl font-black text-amber-400 mb-2 neon-text">최종 KING 등극</h2>
                <p id="winMessage" class="text-gray-200 mb-6 leading-relaxed"></p>
                <button id="newGameFromWinBtn" class="w-full bg-amber-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-amber-600 transition-colors">
                    새로운 판 시작
                </button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const playersContainer = document.getElementById('players-container');
        const dice1El = document.getElementById('dice1'), dice2El = document.getElementById('dice2');
        const rollResultEl = document.getElementById('roll-result');
        const rollBtn = document.getElementById('rollBtn'), resetBtn = document.getElementById('resetBtn');
        const missionPopup = document.getElementById('missionPopup');
        const missionTitle = document.getElementById('missionTitle');
        const missionMessage = document.getElementById('missionMessage');
        const missionOptions = document.getElementById('missionOptions');
        const missionActionButtons = document.getElementById('missionActionButtons');
        const blackKnightBtn = document.getElementById('blackKnightBtn');
        const closeMissionBtn = document.getElementById('closeMissionBtn');
        const winPopup = document.getElementById('winPopup');
        const winMessage = document.getElementById('winMessage');
        const newGameFromWinBtn = document.getElementById('newGameFromWinBtn');

        // Game State
        const playerCount = 5;
        let players = [];
        let currentPlayerIndex = 0;
        let gameActive = true;
        const penaltyNumbers = [7, 8, 9];
        const winScore = 100;
        const diceIcons = ['one', 'two', 'three', 'four', 'five', 'six'];
        const playerAvatars = ['😎', '😂', '😍', '🥳', '🤯'];

        // Mission Cards Data
        const missions = [
            { id: 'drink_one', title: '🍻 원샷!', text: '깔끔하게 원샷!', type: 'penalty', category: 'drink' },
            { id: 'drink_two', title: '🍻 더블샷!', text: '두 잔을 연달아 드링킹!', type: 'penalty', category: 'drink' },
            { id: 'drink_love', title: '❤️ 러브샷', text: '오른쪽 사람과 러브샷하세요!', type: 'penalty', category: 'drink' },
            { id: 'drink_select', title: '👉 지목 원샷', text: '한 명을 지목해서 같이 원샷!', type: 'target', category: 'drink' },
            { id: 'steal', title: '😈 점수 뺏기', text: '한 명을 골라 15점을 뺏어옵니다.', type: 'target' },
            { id: 'double', title: '🚀 더블 찬스', text: '다음 턴에 굴리는 주사위 점수가 2배로 적용됩니다!', type: 'buff'},
            { id: 'reset_one', title: '😱 점수 초기화', text: '가장 점수가 높은 한 명의 점수를 0점으로 만듭니다.', type: 'debuff' },
        ];

        function initializeGame() {
            players = Array.from({ length: playerCount }, (v, i) => ({ 
                name: `Player ${i + 1}`,
                score: 0, 
                avatar: playerAvatars[i],
                hasDoubleBuff: false 
            }));
            currentPlayerIndex = 0;
            gameActive = true;
            
            missionPopup.classList.add('hidden');
            winPopup.classList.add('hidden');
            rollBtn.disabled = false;
            rollBtn.className = "w-full text-white font-bold py-4 px-6 rounded-xl text-xl neon-button";
            rollBtn.textContent = '가보자고! 🎲';

            renderPlayerCards();
            updateUI();
            rollResultEl.innerHTML = `<p class="text-xl font-medium text-gray-300">누구 차례? 가보자고!</p>`;
            dice1El.innerHTML = `<i class="fas fa-dice-one"></i>`;
            dice2El.innerHTML = `<i class="fas fa-dice-one"></i>`;
        }
        
        function renderPlayerCards() {
            playersContainer.innerHTML = '';
            players.forEach((player, index) => {
                const card = document.createElement('div');
                card.id = `player-${index}-card`;
                card.className = 'player-card border-2 border-transparent rounded-lg p-3 text-center bg-gray-800 shadow-lg relative';
                card.innerHTML = `
                    <div id="player-${index}-buff" class="absolute top-1 right-1"></div>
                    <p class="text-3xl">${player.avatar}</p>
                    <p class="font-semibold text-sm text-gray-300">${player.name}</p>
                    <p id="player-${index}-score" class="text-2xl font-bold text-white">${player.score}</p>
                `;
                playersContainer.appendChild(card);
            });
        }

        function updateUI() {
            players.forEach((player, index) => {
                document.getElementById(`player-${index}-score`).textContent = player.score;
                const cardEl = document.getElementById(`player-${index}-card`);
                const buffEl = document.getElementById(`player-${index}-buff`);
                
                if (player.hasDoubleBuff) {
                    buffEl.innerHTML = `<span class="bg-cyan-500 text-white text-xs font-bold px-2 py-1 rounded-full shadow-lg">더블!🚀</span>`;
                } else {
                    buffEl.innerHTML = '';
                }
                
                const isActive = index === currentPlayerIndex;
                cardEl.style.borderColor = isActive ? '#a855f7' : 'transparent';
                cardEl.style.transform = isActive ? 'scale(1.1)' : 'scale(1)';
                cardEl.style.boxShadow = isActive ? '0 0 15px #a855f7' : '';
            });

            const activeCard = document.getElementById(`player-${currentPlayerIndex}-card`);
            if (activeCard) {
                activeCard.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }
        
        // *** BUG FIX START ***
        // Removed the faulty `if (!gameActive)` check. 
        // This function's job is just to apply the score and check for a winner.
        // The `gameActive` state is managed by `rollDice` and `nextTurn`.
        function applyScoreAndCheckWin(playerIndex, score) {
            players[playerIndex].score += score;
            updateUI();
            if (players[playerIndex].score >= winScore) {
                showWinPopup(playerIndex);
                return true; // Game is over
            }
            return false; // Game continues
        }
        // *** BUG FIX END ***

        function rollDice() {
            if (!gameActive) return;
            gameActive = false;
            rollBtn.disabled = true;
            rollBtn.textContent = '굴리는 중...';
            
            dice1El.classList.add('dice-rolling');
            dice2El.classList.add('dice-rolling');

            setTimeout(() => {
                dice1El.classList.remove('dice-rolling');
                dice2El.classList.remove('dice-rolling');

                let d1 = Math.floor(Math.random() * 6) + 1;
                let d2 = Math.floor(Math.random() * 6) + 1;
                let sum = d1 + d2;
                
                dice1El.innerHTML = `<i class="fas fa-dice-${diceIcons[d1 - 1]}"></i>`;
                dice2El.innerHTML = `<i class="fas fa-dice-${diceIcons[d2 - 1]}"></i>`;

                let currentPlayer = players[currentPlayerIndex];
                let scoreToAdd = currentPlayer.hasDoubleBuff ? sum * 2 : sum;
                
                if(currentPlayer.hasDoubleBuff) {
                    rollResultEl.innerHTML = `<p class="text-2xl font-bold text-cyan-400">🚀 더블! ${sum} x 2 = ${scoreToAdd}점!</p>`;
                    currentPlayer.hasDoubleBuff = false; 
                } else {
                    rollResultEl.innerHTML = `<p class="text-2xl font-bold">${d1} + ${d2} = <span class="text-fuchsia-400">${sum}</span></p>`;
                }
                
                if (penaltyNumbers.includes(sum)) {
                    triggerRandomMission(scoreToAdd);
                } else {
                    if(!applyScoreAndCheckWin(currentPlayerIndex, scoreToAdd)){
                       nextTurn();
                    }
                }
            }, 700);
        }

        function nextTurn() {
            if (winPopup.classList.contains('hidden')) {
                gameActive = true; 
                currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
                updateUI();
                rollBtn.disabled = false;
                rollBtn.textContent = '가보자고! 🎲';
            }
        }
        
        function triggerRandomMission(scoreFromRoll) {
            const mission = missions[Math.floor(Math.random() * missions.length)];
            missionTitle.textContent = mission.title;
            missionMessage.textContent = mission.text;
            missionOptions.innerHTML = '';
            
            missionActionButtons.style.display = 'flex';

            if (mission.category === 'drink') {
                blackKnightBtn.style.display = 'block';
                closeMissionBtn.textContent = "벌칙 받기 😈";
                blackKnightBtn.onclick = () => callBlackKnight(scoreFromRoll);
                closeMissionBtn.onclick = () => {
                    missionPopup.classList.add('hidden');
                    if (!applyScoreAndCheckWin(currentPlayerIndex, scoreFromRoll)) {
                        nextTurn();
                    }
                };
            } else {
                blackKnightBtn.style.display = 'none';
                closeMissionBtn.textContent = "확인";
                closeMissionBtn.onclick = () => {
                     missionPopup.classList.add('hidden');
                     if(mission.type !== 'target'){
                        if (!applyScoreAndCheckWin(currentPlayerIndex, scoreFromRoll)) {
                            nextTurn();
                        }
                     }
                };
            }
            
            switch(mission.type) {
                case 'target':
                    missionActionButtons.style.display = 'none';
                    let targets = players.filter((p, i) => i !== currentPlayerIndex);
                    targets.forEach((target) => {
                        const btn = document.createElement('button');
                        btn.className = 'w-full text-left p-2 bg-gray-700 rounded hover:bg-gray-600 transition-colors';
                        btn.textContent = `${target.avatar} ${target.name} (${target.score}점)`;
                        btn.onclick = () => {
                            missionPopup.classList.add('hidden');
                            
                            let gameOver = applyScoreAndCheckWin(currentPlayerIndex, scoreFromRoll);
                            if (gameOver) return;

                            if (mission.id === 'steal') {
                                let stolenScore = Math.min(target.score, 15);
                                players[currentPlayerIndex].score += stolenScore;
                                target.score -= stolenScore;
                            } else if (mission.id === 'drink_select') {
                                rollResultEl.innerHTML = `<p class="text-xl font-bold text-pink-400">${players[currentPlayerIndex].name}님과 ${target.name}님이 함께 원샷!</p>`;
                            }
                            
                            if(!applyScoreAndCheckWin(currentPlayerIndex, 0)) { 
                                nextTurn();
                            }
                        };
                        missionOptions.appendChild(btn);
                    });
                    break;
                case 'buff':
                    if (mission.id === 'double') players[currentPlayerIndex].hasDoubleBuff = true;
                    updateUI(); 
                    break;
                case 'debuff':
                    if (mission.id === 'reset_one') {
                        let maxScore = 0;
                        let targetIndex = -1;
                        players.forEach((p, i) => {
                            if (p.score > maxScore) { maxScore = p.score; targetIndex = i; }
                        });
                        if (targetIndex !== -1) {
                           players[targetIndex].score = 0;
                           missionMessage.textContent = `최고점 플레이어 ${players[targetIndex].name}님의 점수가 0이 되었습니다!`;
                        } else {
                           missionMessage.textContent = `모두 0점이라 초기화할 점수가 없습니다!`;
                        }
                    }
                    updateUI();
                    break;
            }

            missionPopup.classList.remove('hidden');
        }

        function callBlackKnight(scoreFromRoll) {
            missionTitle.textContent = "흑기사 모집! ⚔️";
            missionMessage.textContent = `누가 벌칙을 대신 받고 ${scoreFromRoll}점을 획득하시겠습니까?`;
            missionActionButtons.style.display = 'none';
            missionOptions.innerHTML = '';

            let potentialKnights = players.filter((p, i) => i !== currentPlayerIndex);
            potentialKnights.forEach((knight) => {
                const knightIndex = players.findIndex(p => p.name === knight.name);
                const btn = document.createElement('button');
                btn.className = 'w-full text-left p-2 bg-gray-700 rounded hover:bg-gray-600 transition-colors';
                btn.textContent = `${knight.avatar} ${knight.name}`;
                btn.onclick = () => {
                    missionPopup.classList.add('hidden');
                    rollResultEl.innerHTML = `<p class="text-xl font-bold text-green-400">흑기사 ${knight.name}님이 ${scoreFromRoll}점 획득!</p>`;
                    
                    if (!applyScoreAndCheckWin(knightIndex, scoreFromRoll)) {
                        setTimeout(() => nextTurn(), 1500); 
                    }
                };
                missionOptions.appendChild(btn);
            });
        }

        function showWinPopup(winnerIndex) {
            gameActive = false;
            rollBtn.disabled = true;
            rollBtn.className += " opacity-50 cursor-not-allowed";
            winMessage.innerHTML = `
                <span class="font-bold text-amber-300 text-lg">${players[winnerIndex].name}</span>님이 마침내 100점을 돌파! <br>
                <span class="text-xl mt-2 block">원하는 사람에게 명령권 사용 가능!</span>
            `;
            winPopup.classList.remove('hidden');
        }
        
        // Event Listeners
        rollBtn.addEventListener('click', rollDice);
        resetBtn.addEventListener('click', initializeGame);
        newGameFromWinBtn.addEventListener('click', initializeGame);
        
        initializeGame();
    </script>
</body>
</html>
